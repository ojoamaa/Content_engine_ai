{% extends "base.html" %}

{% block content %}
<div class="bg-slate-800 shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-2xl">
    <header class="mb-8 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 mb-2">
            Content Engine AI
        </h1>
        <p class="text-slate-400 text-lg">Your AI Assistant for Engaging Business & Artisan Content</p>
    </header>

    <div class="mb-6 flex border-b border-slate-700">
        <button id="tabLocalBiz" class="tab-button flex-1 py-3 px-4 text-center font-medium rounded-tl-lg focus:outline-none">Local Business Assistant</button>
        <button id="tabArtisan" class="tab-button flex-1 py-3 px-4 text-center font-medium rounded-tr-lg focus:outline-none">Artisan Storyteller</button>
    </div>

    <div>
        <section id="localBizTool" class="tab-panel">
            <h2 class="text-2xl font-semibold text-center text-sky-400 mb-6">Local Business Social Media Assistant</h2>
            <form id="localBizCaptionForm" class="space-y-6">
                <div>
                    <label for="businessName" class="block text-sm font-medium text-slate-300 mb-1">Business Name (Optional)</label>
                    <input type="text" name="businessName" id="businessName" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Sparkle Cleaners, The Cozy Corner Cafe">
                </div>
                <div>
                    <label for="businessType" class="block text-sm font-medium text-slate-300 mb-1">Type of Business</label>
                    <select name="businessType" id="businessType" required class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-indigo-500">
                        <option value="" disabled selected>Select a business type</option>
                        <option value="Bakery / Confectionery">Bakery / Confectionery</option>
                        <option value="Barber Shop">Barber Shop</option>
                        <option value="Beauty Salon / Spa">Beauty Salon / Spa</option>
                        <option value="Cleaning Services">Cleaning Services</option>
                        <option value="Consulting Services (Business, IT, etc.)">Consulting Services (Business, IT, etc.)</option>
                        <option value="Electronics Store / Repair">Electronics Store / Repair</option>
                        <option value="Event Planner / Services">Event Planner / Services</option>
                        <option value="Fashion Boutique / Tailor">Fashion Boutique / Tailor</option>
                        <option value="Grocery Store / Supermarket">Grocery Store / Supermarket</option>
                        <option value="Hotels">Hotels</option>
                        <option value="Laundry Services">Laundry Services</option>
                        <option value="Nutritionist">Nutritionist</option>
                        <option value="Organic Products">Organic Products</option>
                        <option value="Pharmacy / Chemist">Pharmacy / Chemist</option>
                        <option value="Printing / Photocopy / Cyber Cafe">Printing / Photocopy / Cyber Cafe</option>
                        <option value="Real Estate Agency">Real Estate Agency</option>
                        <option value="Restaurant / Cafe / Bukka / Lounge">Restaurant / Cafe / Bukka / Lounge</option>
                        <option value="Service Apartments / Short let">Service Apartments / Short let</option>
                        <option value="Skin Care Products / Services">Skin Care Products / Services</option>
                        <option value="Other Local Business">Other Local Business</option>
                    </select>
                </div>
                <div>
                    <label for="postType" class="block text-sm font-medium text-slate-300 mb-1">What's the Caption For?</label>
                    <select name="postType" id="postType" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-indigo-500">
                        <option value="new_product_service">New Product/Service Launch</option>
                        <option value="special_offer_discount">Special Offer/Discount</option>
                        <option value="event_announcement">Event Announcement</option>
                        <option value="customer_testimonial_shoutout">Customer Testimonial/Shoutout</option>
                        <option value="behind_the_scenes">Behind-the-Scenes Glimpse</option>
                        <option value="general_engagement_question">General Engagement Question</option>
                        <option value="helpful_tip_advice">Helpful Tip/Advice (related to your business)</option>
                        <option value="holiday_seasonal_post">Holiday/Seasonal Post</option>
                        <option value="update_announcement">General Update/Announcement</option>
                    </select>
                </div>
                <div>
                    <label for="keyMessage" class="block text-sm font-medium text-slate-300 mb-1">Key Message / Details</label>
                    <textarea name="keyMessage" id="keyMessage" rows="3" required class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Our new organic coffee blend is here! Or, Get 20% off all haircuts this Tuesday."></textarea>
                </div>
                <div>
                    <label for="localBizTargetAudience" class="block text-sm font-medium text-slate-300 mb-1">Describe Your Target Audience/Customer (Optional)</label>
                    <textarea name="targetAudience" id="localBizTargetAudience" rows="2" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Young professionals in Lagos, mothers interested in eco-friendly products, etc."></textarea>
                </div>
                <div>
                    <label for="tone" class="block text-sm font-medium text-slate-300 mb-1">Desired Tone</label>
                    <select name="tone" id="tone" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-indigo-500">
                        <option value="friendly_casual">Friendly & Casual</option>
                        <option value="excited_upbeat">Excited & Upbeat</option>
                        <option value="professional_trustworthy">Professional & Trustworthy</option>
                        <option value="humorous_witty">Humorous & Witty</option>
                        <option value="warm_inviting">Warm & Inviting</option>
                    </select>
                </div>
                <div>
                    <label for="callToAction" class="block text-sm font-medium text-slate-300 mb-1">Call to Action (Optional)</label>
                    <select name="callToAction" id="callToAction" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-indigo-500">
                        <option value="visit_us">Visit Us Today!</option>
                        <option value="shop_now_online">Shop Now/Order Online!</option>
                        <option value="book_appointment_now">Book Your Appointment Now!</option>
                        <option value="learn_more">Learn More (link in bio/DM us)</option>
                        <option value="tag_friend">Tag a Friend Who Needs This!</option>
                        <option value="contact_us">Contact Us for Details!</option>
                        <option value="no_cta">No specific CTA (focus on engagement)</option>
                        <option value="custom_cta">Custom (specify in message)</option>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="includeEmojis" name="includeEmojis" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-slate-500 rounded focus:ring-indigo-500">
                        <label for="includeEmojis" class="ml-2 block text-sm text-slate-300">Include Emojis?</label>
                    </div>
                    <div>
                        <label for="numVariationsLocalBiz" class="text-sm font-medium text-slate-300 mr-2">Variations:</label>
                        <select name="numVariations" id="numVariationsLocalBiz" class="p-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-1 focus:ring-indigo-500 text-sm">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                        </select>
                    </div>
                </div>
                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700">✨ Generate Captions & Image</button>
                </div>
            </form>
            <div id="localBizResultsArea" class="mt-10"></div>
        </section>

        <section id="artisanTool" class="tab-panel hidden">
            <h2 class="text-2xl font-semibold text-center text-teal-400 mb-6">Artisan & Handmade Seller Storyteller</h2>
            <form id="artisanDescriptionForm" class="space-y-6">
                <div><label for="creatorName" class="block text-sm font-medium text-slate-300 mb-1">Creator/Brand Name (Optional)</label><input type="text" name="creatorName" id="creatorName" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-teal-500" placeholder="e.g., Ada's Creations"></div>
                <div><label for="productName" class="block text-sm font-medium text-slate-300 mb-1">Product Name/Title</label><input type="text" name="productName" id="artisanProductName" required class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-teal-500" placeholder="e.g., Sunset Glow Earrings"></div>
                <div><label for="productCategory" class="block text-sm font-medium text-slate-300 mb-1">Product Category/Type</label><input type="text" name="productCategory" id="artisanProductCategory" required class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-teal-500" placeholder="e.g., Jewelry, Pottery, Soap"></div>
                <div><label for="keyMaterials" class="block text-sm font-medium text-slate-300 mb-1">Key Materials Used</label><input type="text" name="keyMaterials" id="keyMaterials" required class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-teal-500" placeholder="e.g., Sterling silver, Aso Oke fabric"></div>
                <div><label for="inspiration" class="block text-sm font-medium text-slate-300 mb-1">Inspiration / Story Behind Product (Optional)</label><textarea name="inspiration" id="inspiration" rows="2" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-teal-500" placeholder="e.g., Inspired by Onitsha market vibrancy"></textarea></div>
                <div><label for="uniqueSellingPoints" class="block text-sm font-medium text-slate-300 mb-1">Unique Selling Points / Customer Benefits</label><textarea name="uniqueSellingPoints" id="uniqueSellingPoints" rows="3" required class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-teal-500" placeholder="e.g., One-of-a-kind design, supports local artisans"></textarea></div>
                <div class="flex items-center justify-end"><div><label for="numVariationsArtisan" class="text-sm font-medium text-slate-300 mr-2">Variations:</label><select name="numVariations" id="numVariationsArtisan" class="p-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-1 focus:ring-teal-500 text-sm"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option></select></div></div>
                <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-700 hover:to-cyan-700">🎨 Generate Descriptions & Image</button></div>
            </form>
            <div id="artisanResultsArea" class="mt-10"></div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabButtons = { localBiz: document.getElementById('tabLocalBiz'), artisan: document.getElementById('tabArtisan') };
        const tabPanels = { localBiz: document.getElementById('localBizTool'), artisan: document.getElementById('artisanTool') };
        function switchTab(activeTabKey) {
            Object.values(tabPanels).forEach(panel => panel.classList.add('hidden'));
            Object.values(tabButtons).forEach(button => button.classList.remove('active'));
            tabPanels[activeTabKey].classList.remove('hidden');
            tabButtons[activeTabKey].classList.add('active');
        }
        tabButtons.localBiz.addEventListener('click', () => switchTab('localBiz'));
        tabButtons.artisan.addEventListener('click', () => switchTab('artisan'));
        switchTab('localBiz');
        const localBizCaptionForm = document.getElementById('localBizCaptionForm');
        const localBizResultsArea = document.getElementById('localBizResultsArea');
        if (localBizCaptionForm) {
            handleFormSubmit(localBizCaptionForm, localBizResultsArea, '/generate_local_biz_captions', 'captions');
        }
        const artisanDescriptionForm = document.getElementById('artisanDescriptionForm');
        const artisanResultsArea = document.getElementById('artisanResultsArea');
        if (artisanDescriptionForm) {
            handleFormSubmit(artisanDescriptionForm, artisanResultsArea, '/generate_artisan_description', 'descriptions');
        }
    });
    async function handleFormSubmit(formElement, resultsAreaElement, endpoint, resultKeyName) {
        formElement.addEventListener('submit', async function (event) {
            event.preventDefault();
            const formData = new FormData(formElement);
            const data = Object.fromEntries(formData.entries());
            resultsAreaElement.innerHTML = `<div class="flex justify-center items-center p-6"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500"></div><p class="ml-3 text-slate-400">Generating your content... this may take up to 30 seconds.</p></div>`;
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    let errorText = `HTTP error! status: ${response.status}`;
                    try { const errorResult = await response.json(); errorText = errorResult.error || errorText; } catch (e) { /* ignore */ }
                    throw new Error(errorText);
                }
                const results = await response.json();
                resultsAreaElement.innerHTML = '';
                const contentList = results[resultKeyName];
                const imageData = results.image_data;
                if (imageData) {
                    const imageHolder = document.createElement('div');
                    imageHolder.className = 'mb-8 animate-fadeIn text-center';
                    const imageElement = document.createElement('img');
                    imageElement.className = 'w-full rounded-lg shadow-lg';
                    imageElement.src = `data:image/png;base64,${imageData}`;
                    imageHolder.appendChild(imageElement);
                    const imageButtonContainer = document.createElement('div');
                    imageButtonContainer.className = 'mt-3 flex justify-center flex-wrap gap-3';
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `data:image/png;base64,${imageData}`;
                    downloadLink.download = `content-engine-image-${Date.now()}.png`;
                    downloadLink.textContent = 'Download Image';
                    downloadLink.className = 'inline-block text-sm text-sky-400 hover:text-sky-300 font-medium px-4 py-2 rounded-md border border-sky-400 hover:bg-sky-500 hover:text-white transition-colors duration-150';
                    imageButtonContainer.appendChild(downloadLink);
                    const copyButton = document.createElement('button');
                    copyButton.textContent = 'Copy Image';
                    copyButton.className = 'inline-block text-sm text-sky-400 hover:text-sky-300 font-medium px-4 py-2 rounded-md border border-sky-400 hover:bg-sky-500 hover:text-white transition-colors duration-150';
                    copyButton.onclick = async () => {
                        try {
                            const response = await fetch(`data:image/png;base64,${imageData}`);
                            const blob = await response.blob();
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            copyButton.textContent = 'Copied!';
                            setTimeout(() => { copyButton.textContent = 'Copy Image'; }, 2000);
                        } catch (err) {
                            console.error('Failed to copy image: ', err);
                            alert('Sorry, failed to copy the image. Please try downloading it instead.');
                        }
                    };
                    imageButtonContainer.appendChild(copyButton);
                    imageHolder.appendChild(imageButtonContainer);
                    resultsAreaElement.appendChild(imageHolder);
                }
                if (contentList && contentList.length > 0) {
                    contentList.forEach(item => {
                        const mainContent = item.main_content;
                        if (!mainContent) return;
                        const itemElement = document.createElement('div');
                        itemElement.className = 'bg-slate-700 p-4 rounded-lg shadow mb-4 animate-fadeIn text-left';
                        const mainTextElement = document.createElement('p');
                        mainTextElement.className = 'text-slate-200 mb-2';
                        mainTextElement.textContent = mainContent;
                        itemElement.appendChild(mainTextElement);
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'mt-3 flex flex-wrap gap-2';
                        const copyCaptionButton = document.createElement('button');
                        copyCaptionButton.className = 'text-xs text-indigo-400 hover:text-indigo-300 font-medium px-2 py-1 rounded-md border border-indigo-400 hover:bg-indigo-500 hover:text-white transition-colors duration-150';
                        copyCaptionButton.textContent = 'Copy Caption';
                        copyCaptionButton.onclick = function () {
                            navigator.clipboard.writeText(mainContent).then(() => {
                                copyCaptionButton.textContent = 'Copied!';
                                setTimeout(() => { copyCaptionButton.textContent = 'Copy Caption'; }, 2000);
                            });
                        };
                        buttonContainer.appendChild(copyCaptionButton);
                        itemElement.appendChild(buttonContainer);
                        resultsAreaElement.appendChild(itemElement);
                    });
                } else if (results.error) {
                    resultsAreaElement.innerHTML = `<div class="bg-red-500/20 text-red-300 p-4 rounded-lg shadow mb-4">${results.error}</div>`;
                } else if (!imageData) {
                    resultsAreaElement.innerHTML = `<div class="bg-slate-700 text-slate-400 p-4 rounded-lg shadow mb-4">No content generated. Try adjusting your input!</div>`;
                }
            } catch (error) {
                console.error('Error fetching content:', error);
                resultsAreaElement.innerHTML = `<div class="bg-red-500/20 text-red-300 p-4 rounded-lg shadow mb-4">An error occurred: ${error.message}. Please try again.</div>`;
            }
        });
    }
</script>
{% endblock %}